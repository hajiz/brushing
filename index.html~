<html>
<head>
<title>Enter brushing app</title>
<link href="style.css" rel="stylesheet" />
<script type="text/javascript" src="d3.js"></script>
<script type="text/javascript" src="jquery.js"></script>

<script type="text/javascript" src="dataStore.js"></script>
<script type="text/javascript" src="selection.js"></script>
<script type="text/javascript" src="charting.js"></script>
<script type="text/javascript" src="appearance.js"></script>
<script type="text/javascript" src="broadcast.js"></script>
<script type="text/javascript" src="logger.js"></script>
<script type="text/javascript" src="chartDrawer.js"></script>


<script type="text/javascript">
var datasets = {"efashion":"Fashion Dataset", "shopping_complete":"Shopping Center", "carbon": "Carbon Emission", "smoking_small":"Smoking, small version",
		"baseball": "Baseball Dataset", "cereal": "Cereal Dataset", "earthquake":"Earthquake Dataset", "nhl":"NHL Dataset", "sleeping": "Sleeping Patterns"};
var dataset_dimensions = {"efashion":{"dimension": ["Year", "Quarter", "Lines", "State"], "measure":["Sales revenue#"], "aggregation":"sum"},
			"shopping_complete":{"dimension": ["Gender", "Age Group", "Shopping Mall", "Frequency"], "measure":["Average Rating"], "aggregation":"average"},
			"carbon":{"dimension": ["Country"], "measure": ["Total CO2, 2005, million tonnes", "Cars per 1000 people"], "aggregation":"sum"},
			"smoking_small":{"dimension":["Gender", "Race", "Age", "Smoked > 100 Cigarettes in Lifetime"], "measure":["Cholesterol (mg/100mL)"], "aggregation":"sum"},
			"baseball":{"dimension":["Year", "League", "Rank", "Fielding Percentage"], "measure":["Wins"], "aggregation":"sum"}};
var my_id = -1;
var my_session = -1;
var my_dataset = '';
var my_othersname = 'Others';
var last_moved = new Date();
var last_clicked = new Date();
var draw_separate = false;
$(document).ready (function () {
	$("#brushing").hide();
	$("create [name='dataset']").html("");
	$.each(Object.keys(datasets), function (i, v) { $("#create [name='dataset']").append("<option value='" + v + "'>" + datasets[v] + "</option>"); });
	fill_sessions ();
	$("#log").click(function () {
		$.ajax("http://142.104.68.169/server/brushing/log.php", {
			type:"POST",
			data: { session: my_session, user: my_id, log: JSON.stringify(logs) }
		});
	});
	$("#log, #status").hide();
	$(document).keypress(function (e) { if(e.charCode == 108) $("#log, #status").toggle(); });
	$("#create_btn").click(function () {
		var name = $('#create [name="sessionname"]').val();
		if (name.length < 1) {
			alert('You should enter a name for the session');
			return;
		}
		var dataset = $('#create [name="dataset"]').val();
		$.ajax('http://142.104.68.169/server/brushing/createsession.php?name=' + name + '&dataset=' + dataset, 
			{
				"success": function (data) { if (data.length != 0) alert("failure with error: " + data); }
			});
		fill_sessions();
	});
	
	$("#join_btn").click(function () {
		var name = $('#join [name="name"]').val();
		if (name.length < 1) {
			alert('Enter your name please');
			return;
		}
		var session = $('#join [name="session"]').val();
		if (session == null || session.length < 1) {
			alert('First create a session');
			return;
		}
		draw_separate = ($("#login [name='draw_separate']").is(":checked"));
		$.ajax('../../server/brushing/joinsession.php?name=' + name + '&session=' + session, 
			{ "dataType":"json", "success": function (data) { my_session = session; my_id = data.id; my_dataset = data.dataset; jump_to_brushing(); } });
	});
});

function fill_sessions () {
	$("#join [name='session']").html("");
	$.ajax('../../server/brushing/listsession.php', 
		{ "dataType":"json", "success": function (data) { $.each(data, function (i, v) { $("#join [name='session']").append("<option value='" + v.id + "'>" + v.name + " (" + datasets[v.dataset] + ")</option>"); }); } });
}

var store;
var temp;
var my_selection = new selection();
var other_selection = new selection();
var base_selection = my_selection;
var hub = new broadcast();
var alternative_hub = new broadcast();
function jump_to_brushing () {
	$("#login").hide();
	$("#brushing").show();
	store = new dataStore("data/" + my_dataset + ".json", loaded);
}

function loaded (success) {
	if (!success)
		alert ("no data loaded!");
	
	// default drawing
	var dimensions = dataset_dimensions[my_dataset].dimension;
	var measures = dataset_dimensions[my_dataset].measure;
	var max = dimensions.length;
	if (max < measures.length) max = measures.length;
	if (draw_separate && max > 2) max = 2;
	for (var i = 0; i < max; i ++) {
		var dimension, measure;
		if (i < dimensions.length) dimension = dimensions[i];
		else dimension = dimensions[0];
		if (i < measures.length) measure = measures[i];
		else measure = measures[0];
		var _chart = chartDrawer ("bar", dimension, null, measure, dataset_dimensions[my_dataset].aggregation, 
				store, hub, my_selection, other_selection, true, !draw_separate, $("#stacked").is(":checked"), true, "#main_chart"+(i+1));
	}
	if (draw_separate) {
		for (var i = 0; i < max; i ++) {
			var dimension, measure;
			if (i < dimensions.length) dimension = dimensions[i];
			else dimension = dimensions[0];
			if (i < measures.length) measure = measures[i];
			else measure = measures[0];
			var _chart = chartDrawer ("bar", dimension, null, measure, dataset_dimensions[my_dataset].aggregation, 
				store, alternative_hub, my_selection, other_selection, false, true, $("#stacked").is(":checked"), false, "#main_chart"+(i+3));
		}
	}

	$(document).mousemove(function () {
		var now = new Date();
		var diff = (now.getTime() - last_moved.getTime());
		var threshold = 5 * 1000;
		if (diff > threshold)
			log("Mouse stopped for " + (diff / 1000) + " seconds from " + last_moved.toString());
		last_moved = now;
	});

	$(document).click(function () {
		var now = new Date();
		var diff = (now.getTime() - last_clicked.getTime());
		var threshold = 5 * 1000;
		if (diff > threshold)
			log("No click for " + (diff / 1000) + " seconds from " + last_clicked.toString());
		last_moved = now;
	});

	setTimeout("download_selection();", 2000);
}

function upload_selection () {
	$.ajax("../../server/brushing/setselection.php?session="+my_session+"&user="+my_id+"&selection="+JSON.stringify(my_selection.selection),
		{ "success": function (data) { if (data.length > 0) alert ("failure with error: " + data); } });
}

function download_selection () {
	$.ajax("../../server/brushing/getselection.php?session="+my_session+"&user="+my_id,
		{ "dataType":"json", 
			"error": function (jqXHR, textStatus, errorThrown) { $("#status").html("Not Connected"); alert(jqXHR + " " + textStatus + " " + errorThrown); }, 
			"success": function (data) { 
				$("#status").html("Not Connected"); 
				if (data.length > 0) { 
					my_othersname = data[0].name;
					var temp_other_selection = data[0].selection.replace(/'/g, "\"");
					if (temp_other_selection == "")
						temp_other_selection = "{}";
					if (JSON.stringify(other_selection.selection) != temp_other_selection) {
						other_selection.selection = JSON.parse(temp_other_selection); 
						hub.broadcast();
						alternative_hub.broadcast();
					}
				} else {
					// reset others selection
					my_othersname = 'Others';
					if (JSON.stringify(other_selection.selection) != "{}") {
						other_selection.selection = {};
						hub.broadcast();
						alternative_hub.broadcast();
					}
				}
				$("#status").html("Connected"); 
				setTimeout("download_selection();", 1000); } 
		}
	);
}
</script>
</head>

<body>
<div id="login">
	<div id="create">
	<h1>Create a new session</h1>
	<span class="label">Session Name:</span><input name="sessionname" /><br/>
	<span class="label">Dataset:</span><select name="dataset">
	</select><br/>
	<button id="create_btn">Create</button>
	</div>
	<h1>or</h1>
	<div id="join">
	<h1>Join an existing one</h1>
	<span class="label">Name:</span><input name="name" /><br/>
	<span class="label">Session Name:</span><select name="session">
	<!-- sample <option value="1">test</option>-->
	</select><br/>
	<button id="join_btn">Join</button>
	<input name="draw_separate" type="checkbox">draw separate</input>
	<input id="stacked" type="checkbox">draw stacked</input>
	</div>
</div>

<div id="brushing">
	<span id="selection"></span><br/>
	<div class="chart" id="main_chart1"></div>
	<div class="chart" id="main_chart3"></div>
	<div class="chart" id="main_chart2"></div>
	<div class="chart" id="main_chart4"></div>
	<br/><span id="status">Connected</span><button id="log">Log</button>
</div>
</body>
</html>